<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar QR Code Pix</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
    <h1>Gerar QR Code Pix</h1>
    <div>
        <input type="number" id="amount" placeholder="Valor">
        <button onclick="generateQRCode()">Gerar QR Code</button>
    </div>
    <canvas id="qrcode"></canvas>
    <div>
        <textarea id="pixCopyPaste" rows="4" cols="50" readonly></textarea>
        <button onclick="copyToClipboard()">Copiar 'Copia e Cola'</button>
    </div>

    <script>
        const cnpjPixKey = "43227642000130"; // Substitua pelo seu CNPJ fixo

        function padStart(str, targetLength, padString) {
            targetLength = targetLength >> 0; // Truncate if number, or convert non-number to 0;
            padString = String(padString || ' ');
            if (str.length > targetLength) {
                return String(str);
            } else {
                targetLength = targetLength - str.length;
                if (targetLength > padString.length) {
                    padString += padString.repeat(targetLength / padString.length); // Append to original to ensure we are longer than needed
                }
                return padString.slice(0, targetLength) + String(str);
            }
        }

        function calculateCRC(payload) {
            let polinomio = 0x1021;
            let resultado = 0xFFFF;

            for (let byte of payload) {
                resultado ^= (byte.charCodeAt(0) << 8);
                for (let bit = 0; bit < 8; bit++) {
                    if ((resultado <<= 1) & 0x10000) resultado ^= polinomio;
                    resultado &= 0xFFFF;
                }
            }

            return padStart(resultado.toString(16).toUpperCase(), 4, '0');
        }

        function formatField(id, value) {
            const length = value.length.toString().padStart(2, '0');
            return id + length + value;
        }

        function generateQRCode() {
            const amount = parseFloat(document.getElementById('amount').value).toFixed(2);

            const payloadFormatIndicator = formatField('00', '01');
            const pointOfInitiationMethod = formatField('01', '12');
            const merchantAccountInformation = formatField('26',
                formatField('00', 'BR.GOV.BCB.PIX') +
                formatField('01', cnpjPixKey));
            const merchantCategoryCode = formatField('52', '0000');
            const transactionCurrency = formatField('53', '986');
            const transactionAmount = formatField('54', amount);
            const countryCode = formatField('58', 'BR');
            const merchantName = formatField('59', 'Wanderlei Junior');
            const merchantCity = formatField('60', 'TARUMA');
            const additionalDataFieldTemplate = formatField('62', formatField('05', '***'));

            let pixPayload = payloadFormatIndicator + pointOfInitiationMethod + merchantAccountInformation +
                merchantCategoryCode + transactionCurrency + transactionAmount + countryCode +
                merchantName + merchantCity + additionalDataFieldTemplate + '6304';

            const crc = calculateCRC(pixPayload);
            pixPayload += crc;

            // Gerar QR Code
            QRCode.toCanvas(document.getElementById('qrcode'), pixPayload, function (error) {
                if (error) console.error(error);
                console.log('QR code gerado!');
            });

            // Exibir payload para copiar e colar
            document.getElementById('pixCopyPaste').value = pixPayload;
        }

        function copyToClipboard() {
            const copyText = document.getElementById('pixCopyPaste');
            copyText.select();
            copyText.setSelectionRange(0, 99999); // Para dispositivos móveis

            document.execCommand("copy");
            alert("Código 'Copia e Cola' copiado: " + copyText.value);
        }
    </script>
</body>
</html>
